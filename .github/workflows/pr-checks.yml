name: PR Checks

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

jobs:
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    
    steps:  
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: Run linter (if available)
      continue-on-error: true
      run: |
        if command -v pylint &> /dev/null; then
          find . -name "*.py" -not -path "./.git/*" -not -path "./venv/*" -not -path "./env/*" | xargs pylint --disable=all --enable=E,F || true
        fi
        
    - name: Check for syntax errors
      run: |
        find . -name "*.py" -not -path "./.git/*" -not -path "./venv/*" -not -path "./env/*" -exec python -m py_compile {} \;
        
    - name: Run tests (if available)
      continue-on-error: true
      run: |
        if [ -d "tests" ] || [ -f "test_*.py" ] || [ -f "*_test.py" ]; then
          python -m pytest tests/ || python -m pytest test_*.py || true
        else
          echo "No tests found, skipping..."
        fi

  check-pr-description:
    name: Check PR Description
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check PR description
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          const minLength = 50;
          
          if (!pr.body || pr.body.length < minLength) {
            core.setFailed(`PR description is too short. Please provide at least ${minLength} characters describing your changes.`);
          } else {
            console.log('✓ PR description meets requirements');
          }

  check-commit-messages:
    name: Check Commit Messages
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Validate commit messages
      run: |
        # Get commits in PR
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
        else
          BASE_SHA="HEAD~1"
          HEAD_SHA="HEAD"
        fi
        
        # Check each commit message
        git log --format="%s" ${BASE_SHA}..${HEAD_SHA} | while read msg; do
          if [ ${#msg} -lt 10 ]; then
            echo "❌ Commit message too short: '$msg'"
            exit 1
          fi
          echo "✓ Commit message OK: '$msg'"
        done

  request-review:
    name: Request Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Request review from code owner
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          const reviewer = 'felipe-delvalle';
          
          // Check if reviewer is already requested
          const reviews = await github.rest.pulls.listRequestedReviewers({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: pr.number
          });
          
          const requestedReviewers = reviews.data.users.map(u => u.login);
          
          if (!requestedReviewers.includes(reviewer)) {
            await github.rest.pulls.requestReviewers({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              reviewers: [reviewer]
            });
            console.log(`✓ Requested review from @${reviewer}`);
          } else {
            console.log(`✓ @${reviewer} is already requested as a reviewer`);
          }
