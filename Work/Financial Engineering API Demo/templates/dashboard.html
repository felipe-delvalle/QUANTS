<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ title }}</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #0b1221; color: #e8edf6; }
    h1 { color: #5de0e6; }
    .controls { background: #111829; border: 1px solid #243047; padding: 16px; border-radius: 8px; margin-bottom: 20px; }
    .controls label { display: inline-block; margin-right: 10px; color: #e8edf6; }
    .controls input[type="number"] { width: 80px; padding: 6px; background: #182035; border: 1px solid #243047; color: #e8edf6; border-radius: 4px; }
    .controls button { padding: 8px 16px; background: #5de0e6; color: #0b1221; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .controls button:hover { background: #4bc4ca; }
    .controls button:disabled { background: #243047; color: #666; cursor: not-allowed; }
    .status { margin-top: 10px; color: #5de0e6; }
    .loading { display: none; color: #5de0e6; }
    .loading.active { display: inline-block; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { border: 1px solid #243047; padding: 8px; text-align: left; }
    th { background: #182035; }
    tr:nth-child(even) { background: #111829; }
    .buy { color: #6be07b; font-weight: bold; }
    .sell { color: #ff7b7b; font-weight: bold; }
    .hold { color: #ffd700; font-weight: bold; }
    .empty { text-align: center; padding: 40px; color: #666; }
    .warning-banner { background: #ffa500; color: #0b1221; padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
    .warning-banner.hidden { display: none; }
    .warning-banner .close-btn { background: transparent; border: none; color: #0b1221; font-size: 20px; cursor: pointer; padding: 0 8px; font-weight: bold; }
    .warning-banner .close-btn:hover { color: #ff0000; }
    .quick-buttons { display: inline-block; margin-left: 12px; }
    .quick-buttons button { padding: 6px 12px; margin-right: 6px; font-size: 13px; }
    .demo-indicator { color: #ffd700; font-weight: bold; margin-left: 12px; }
    .resources-section { background: #111829; border: 1px solid #243047; padding: 16px; border-radius: 8px; margin-bottom: 20px; }
    .resources-section h2 { color: #5de0e6; margin-top: 0; margin-bottom: 12px; font-size: 18px; }
    .resources-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; }
    .resource-item { background: #182035; border: 1px solid #243047; padding: 12px; border-radius: 6px; }
    .resource-item .method { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-right: 8px; }
    .resource-item .method.get { background: #6be07b; color: #0b1221; }
    .resource-item .method.post { background: #5de0e6; color: #0b1221; }
    .resource-item .endpoint { color: #5de0e6; font-family: monospace; font-size: 14px; margin: 4px 0; }
    .resource-item .description { color: #a0a8b8; font-size: 12px; margin-top: 4px; }
    .resource-item a { color: #5de0e6; text-decoration: none; }
    .resource-item a:hover { text-decoration: underline; }
    .strategy-section { background: #111829; border: 1px solid #243047; padding: 16px; border-radius: 8px; margin-bottom: 20px; }
    .strategy-section h2 { color: #5de0e6; margin-top: 0; margin-bottom: 12px; font-size: 18px; }
    .strategy-section h3 { color: #5de0e6; margin-top: 16px; margin-bottom: 8px; font-size: 16px; border-bottom: 1px solid #243047; padding-bottom: 8px; }
    .on-sale-header { color: #6be07b; }
    .overbought-header { color: #ff7b7b; }
    .strategy-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    .strategy-table th, .strategy-table td { border: 1px solid #243047; padding: 8px; text-align: left; font-size: 13px; }
    .strategy-table th { background: #182035; }
    .strategy-table tr:nth-child(even) { background: #111829; }
    .empty-strategy { text-align: center; padding: 20px; color: #666; font-style: italic; }
    .auto-refresh-controls { display: inline-block; margin-left: 16px; padding-left: 16px; border-left: 1px solid #243047; }
    .auto-refresh-controls label { margin-right: 8px; color: #a0a8b8; font-size: 13px; }
    .auto-refresh-controls input[type="number"] { width: 60px; padding: 4px; background: #182035; border: 1px solid #243047; color: #e8edf6; border-radius: 4px; font-size: 12px; }
    .auto-refresh-controls input[type="checkbox"] { margin-right: 4px; }
    .auto-refresh-status { display: inline-block; margin-left: 12px; color: #5de0e6; font-size: 12px; }
    .auto-refresh-status.active { color: #6be07b; }
    .auto-refresh-status.active::before { content: "üîÑ "; }
    /* Sector filter styles */
    .sector-filter-section { background: #111829; border: 1px solid #243047; padding: 16px; border-radius: 8px; margin-bottom: 20px; }
    .sector-filter-section h3 { color: #5de0e6; margin-top: 0; margin-bottom: 12px; font-size: 16px; }
    .sector-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; margin-bottom: 12px; }
    .sector-item { background: #182035; border: 1px solid #243047; padding: 8px 12px; border-radius: 4px; display: flex; align-items: center; transition: all 0.2s; }
    .sector-item:hover { border-color: #5de0e6; }
    .sector-item input[type="checkbox"] { margin-right: 8px; cursor: pointer; }
    .sector-item label { cursor: pointer; flex: 1; display: flex; justify-content: space-between; align-items: center; }
    .sector-item .count { color: #a0a8b8; font-size: 12px; margin-left: 8px; }
    .sector-item.checked { background: #243047; border-color: #5de0e6; }
    .filter-actions { display: flex; gap: 10px; margin-top: 12px; }
    .filter-actions button { padding: 6px 12px; font-size: 13px; }
    .symbol-count { color: #5de0e6; font-size: 14px; margin-top: 8px; }
    .asset-type-filter { margin-top: 16px; padding-top: 16px; border-top: 1px solid #243047; }
    .asset-type-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; }

    /* Clickable rows */
    #resultsTable tbody tr { cursor: pointer; transition: background-color 0.2s; }
    #resultsTable tbody tr:hover { background-color: #1a2238; }
    .strategy-table tbody tr { cursor: pointer; transition: background-color 0.2s; }
    .strategy-table tbody tr:hover { background-color: #1a2238; }
  </style>
</head>
<body>
  <h1>{{ title }}</h1>
  <p>Live opportunities across assets. Data is fetched on request.{% if demo_mode %}<span class="demo-indicator">[DEMO MODE]</span>{% endif %}</p>
  
  <div class="resources-section">
    <h2>üìö Available API Resources</h2>
    <div class="resources-grid">
      <div class="resource-item">
        <span class="method get">GET</span>
        <div class="endpoint"><a href="/" target="_blank">/</a></div>
        <div class="description">API root - List all available endpoints</div>
      </div>
      <div class="resource-item">
        <span class="method get">GET</span>
        <div class="endpoint"><a href="/health" target="_blank">/health</a></div>
        <div class="description">Health check endpoint</div>
      </div>
      <div class="resource-item">
        <span class="method get">GET</span>
        <div class="endpoint"><a href="/dashboard" target="_blank">/dashboard</a></div>
        <div class="description">Trading opportunities dashboard (current page)</div>
      </div>
      <div class="resource-item">
        <span class="method get">GET</span>
        <div class="endpoint"><a href="/gallery" target="_blank">/gallery</a></div>
        <div class="description">Chart gallery - View generated visualizations</div>
      </div>
      <div class="resource-item">
        <span class="method post">POST</span>
        <div class="endpoint">/scan</div>
        <div class="description">Scan for trading opportunities (requires API key)</div>
      </div>
      <div class="resource-item">
        <span class="method post">POST</span>
        <div class="endpoint">/backtest</div>
        <div class="description">Backtest trading strategies (requires API key)</div>
      </div>
    </div>
  </div>
  
  {% if failed_sources and failed_sources|length > 0 %}
  <div id="warningBanner" class="warning-banner">
    <span>‚ö†Ô∏è Could not fetch data from: {{ ", ".join(failed_sources) }}</span>
    <button class="close-btn" onclick="document.getElementById('warningBanner').classList.add('hidden')">√ó</button>
  </div>
  {% endif %}
  
  <div class="controls">
    <label for="threshold">Confidence Threshold:</label>
    <input type="number" id="threshold" min="0" max="1" step="0.05" value="{{ threshold }}" />
    <button id="updateBtn" onclick="updateThreshold()">Update Threshold</button>
    <div class="quick-buttons">
      <button onclick="setThreshold(0.0)">Show All (0.0)</button>
      <button onclick="setThreshold(0.2)">Low (0.2)</button>
      <button onclick="setThreshold(0.4)">Medium (0.4)</button>
    </div>
    <div class="status">
      <span id="statusText">Found {{ count }} opportunities</span>
      <span class="loading" id="loading">Scanning...</span>
    </div>
    <div class="auto-refresh-controls">
      <label for="autoRefreshToggle">Auto-refresh:</label>
      <input type="checkbox" id="autoRefreshToggle" />
      <label for="refreshInterval">Interval (sec):</label>
      <input type="number" id="refreshInterval" min="10" max="300" value="30" step="10" />
      <span id="autoRefreshStatus" class="auto-refresh-status"></span>
    </div>
  </div>

  <div class="sector-filter-section">
    <h3>üìä Filter by Sector</h3>
    <div class="sector-grid">
      <div class="sector-item" data-sector="Information Technology">
        <input type="checkbox" id="sector-tech" value="Information Technology" checked>
        <label for="sector-tech">
          <span>Information Technology</span>
          <span class="count">(40)</span>
        </label>
      </div>
      <div class="sector-item" data-sector="Health Care">
        <input type="checkbox" id="sector-health" value="Health Care" checked>
        <label for="sector-health">
          <span>Health Care</span>
          <span class="count">(39)</span>
        </label>
      </div>
      <div class="sector-item" data-sector="Financials">
        <input type="checkbox" id="sector-finance" value="Financials" checked>
        <label for="sector-finance">
          <span>Financials</span>
          <span class="count">(38)</span>
        </label>
      </div>
      <div class="sector-item" data-sector="Consumer Discretionary">
        <input type="checkbox" id="sector-consumer-d" value="Consumer Discretionary" checked>
        <label for="sector-consumer-d">
          <span>Consumer Discretionary</span>
          <span class="count">(40)</span>
        </label>
      </div>
      <div class="sector-item" data-sector="Communication Services">
        <input type="checkbox" id="sector-comm" value="Communication Services" checked>
        <label for="sector-comm">
          <span>Communication Services</span>
          <span class="count">(30)</span>
        </label>
      </div>
      <div class="sector-item" data-sector="Industrials">
        <input type="checkbox" id="sector-industrial" value="Industrials" checked>
        <label for="sector-industrial">
          <span>Industrials</span>
          <span class="count">(40)</span>
        </label>
      </div>
      <div class="sector-item" data-sector="Consumer Staples">
        <input type="checkbox" id="sector-consumer-s" value="Consumer Staples" checked>
        <label for="sector-consumer-s">
          <span>Consumer Staples</span>
          <span class="count">(30)</span>
        </label>
      </div>
      <div class="sector-item" data-sector="Energy">
        <input type="checkbox" id="sector-energy" value="Energy" checked>
        <label for="sector-energy">
          <span>Energy</span>
          <span class="count">(30)</span>
        </label>
      </div>
      <div class="sector-item" data-sector="Utilities">
        <input type="checkbox" id="sector-utilities" value="Utilities" checked>
        <label for="sector-utilities">
          <span>Utilities</span>
          <span class="count">(30)</span>
        </label>
      </div>
      <div class="sector-item" data-sector="Real Estate">
        <input type="checkbox" id="sector-realestate" value="Real Estate" checked>
        <label for="sector-realestate">
          <span>Real Estate</span>
          <span class="count">(30)</span>
        </label>
      </div>
      <div class="sector-item" data-sector="Materials">
        <input type="checkbox" id="sector-materials" value="Materials" checked>
        <label for="sector-materials">
          <span>Materials</span>
          <span class="count">(30)</span>
        </label>
      </div>
    </div>
    
    <div class="filter-actions">
      <button onclick="selectAllSectors()">Select All</button>
      <button onclick="clearAllSectors()">Clear All</button>
      <button onclick="applyFilters()" style="background: #6be07b; color: #0b1221;">Apply Filters</button>
    </div>
    
    <div class="symbol-count">
      Selected: <strong id="selectedSymbolCount">377</strong> symbols
    </div>
    
    <div class="asset-type-filter">
      <h4 style="color: #5de0e6; margin: 0 0 8px 0; font-size: 14px;">Asset Types</h4>
      <div class="asset-type-grid">
        <div class="sector-item" data-type="crypto">
          <input type="checkbox" id="type-crypto" value="crypto">
          <label for="type-crypto">
            <span>Crypto</span>
            <span class="count">(20)</span>
          </label>
        </div>
        <div class="sector-item" data-type="forex">
          <input type="checkbox" id="type-forex" value="forex">
          <label for="type-forex">
            <span>Forex</span>
            <span class="count">(20)</span>
          </label>
        </div>
        <div class="sector-item" data-type="commodities">
          <input type="checkbox" id="type-commodities" value="commodities">
          <label for="type-commodities">
            <span>Commodities</span>
            <span class="count">(12)</span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <div class="strategy-section">
    <h2>üí∞ Buy Low, Sell High Strategy</h2>
    
    <h3 class="on-sale-header">üõí On Sale / Buy Opportunity</h3>
    {% if on_sale and on_sale|length > 0 %}
    <table class="strategy-table">
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Asset</th>
          <th>Price</th>
          <th>Confidence</th>
          <th>Reasons</th>
        </tr>
      </thead>
      <tbody>
        {% for opp in on_sale %}
        <tr>
          <td>{{ opp["symbol"] }}</td>
          <td>{{ opp.get("asset_type", "stock").upper() }}</td>
          <td>${{ "%.2f"|format(opp.get("current_price", opp.get("price", 0))) }}</td>
          <td>{{ (opp["confidence"]*100)|round(0) }}%</td>
          <td>{{ ", ".join(opp.get("reasons", [])[:2]) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="empty-strategy">No undervalued opportunities found at current threshold.</div>
    {% endif %}
    
    <h3 class="overbought-header">üìà Overbought</h3>
    {% if overbought and overbought|length > 0 %}
    <table class="strategy-table">
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Asset</th>
          <th>Price</th>
          <th>Confidence</th>
          <th>Reasons</th>
        </tr>
      </thead>
      <tbody>
        {% for opp in overbought %}
        <tr>
          <td>{{ opp["symbol"] }}</td>
          <td>{{ opp.get("asset_type", "stock").upper() }}</td>
          <td>${{ "%.2f"|format(opp.get("current_price", opp.get("price", 0))) }}</td>
          <td>{{ (opp["confidence"]*100)|round(0) }}%</td>
          <td>{{ ", ".join(opp.get("reasons", [])[:2]) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="empty-strategy">No overbought opportunities found at current threshold.</div>
    {% endif %}
  </div>
  
  <h2 style="color: #5de0e6; margin-top: 30px; margin-bottom: 12px;">All Opportunities</h2>
  <table id="resultsTable">
    <thead>
      <tr>
        <th>Symbol</th>
        <th>Asset</th>
        <th>Signal</th>
        <th>Confidence</th>
        <th>Price</th>
        <th>Trend</th>
        <th>Reasons</th>
      </tr>
    </thead>
    <tbody id="resultsBody">
      {% if opportunities %}
        {% for opp in opportunities %}
        <tr>
          <td>{{ opp["symbol"] }}</td>
          <td>{{ opp.get("asset_type", "stock").upper() }}</td>
          <td class="{{ 'buy' if opp['signal']=='BUY' else 'sell' if opp['signal']=='SELL' else 'hold' if opp['signal']=='HOLD' else '' }}">{{ opp["signal"] }}</td>
          <td>{{ (opp["confidence"]*100)|round(0) }}%</td>
          <td>${{ "%.2f"|format(opp.get("current_price", opp.get("price", 0))) }}</td>
          <td>{{ opp.get("trend","-") }}</td>
          <td>{{ ", ".join(opp.get("reasons", [])[:3]) }}</td>
        </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="7" class="empty">No opportunities found with current threshold. Try lowering the threshold.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>

  <script>
    function setThreshold(value) {
      document.getElementById('threshold').value = value;
      updateThreshold();
    }
    
    function updateThreshold() {
      const threshold = document.getElementById('threshold').value;
      const btn = document.getElementById('updateBtn');
      const loading = document.getElementById('loading');
      const statusText = document.getElementById('statusText');
      const resultsBody = document.getElementById('resultsBody');
      
      // Disable button and show loading
      btn.disabled = true;
      loading.classList.add('active');
      statusText.textContent = 'Scanning...';
      
      // Validate threshold
      const thresholdValue = parseFloat(threshold);
      if (isNaN(thresholdValue) || thresholdValue < 0 || thresholdValue > 1) {
        statusText.textContent = 'Invalid threshold (must be between 0 and 1)';
        btn.disabled = false;
        loading.classList.remove('active');
        return;
      }
      
      // Check if demo mode is active
      const urlParams = new URLSearchParams(window.location.search);
      const demoMode = urlParams.get('demo') === 'true';
      const demoParam = demoMode ? '&demo=true' : '';
      
      // Fetch new results
      fetch(`/dashboard?threshold=${thresholdValue}${demoParam}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.text();
        })
        .then(html => {
          // Parse the HTML response
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const newBody = doc.getElementById('resultsBody');
          const newThresholdInput = doc.getElementById('threshold');
          
          // Update the table body
          if (newBody) {
            resultsBody.innerHTML = newBody.innerHTML;
          }
          
          // Explicitly re-attach click handlers after table update
          // This ensures handlers work even if MutationObserver misses the update
          setTimeout(function() {
            if (typeof window.addClickHandlers === 'function') {
              window.addClickHandlers();
            }
          }, 100);
          
          // Update threshold input value (in case server adjusted it)
          if (newThresholdInput) {
            document.getElementById('threshold').value = newThresholdInput.value;
          }
          
          // Update status
          const newStatus = doc.getElementById('statusText');
          if (newStatus) {
            const countMatch = newStatus.textContent.match(/(\d+)/);
            const count = countMatch ? countMatch[1] : '0';
            statusText.textContent = `Found ${count} opportunities`;
          }
          
          // Update warning banner if present
          const newWarningBanner = doc.getElementById('warningBanner');
          const currentWarningBanner = document.getElementById('warningBanner');
          if (newWarningBanner && !currentWarningBanner) {
            // Insert warning banner before controls
            const controls = document.querySelector('.controls');
            controls.insertAdjacentHTML('beforebegin', newWarningBanner.outerHTML);
          } else if (newWarningBanner && currentWarningBanner) {
            currentWarningBanner.outerHTML = newWarningBanner.outerHTML;
          } else if (!newWarningBanner && currentWarningBanner) {
            currentWarningBanner.remove();
          }
          
          // Update demo mode indicator
          const demoIndicator = doc.querySelector('.demo-indicator');
          const currentDemoIndicator = document.querySelector('.demo-indicator');
          if (demoIndicator && !currentDemoIndicator) {
            const desc = document.querySelector('p');
            desc.insertAdjacentHTML('beforeend', demoIndicator.outerHTML);
          } else if (demoIndicator && currentDemoIndicator) {
            currentDemoIndicator.outerHTML = demoIndicator.outerHTML;
          } else if (!demoIndicator && currentDemoIndicator) {
            currentDemoIndicator.remove();
          }
          
          // Update "Buy Low, Sell High Strategy" section
          const newStrategySection = doc.querySelector('.strategy-section');
          const currentStrategySection = document.querySelector('.strategy-section');
          if (newStrategySection && currentStrategySection) {
            currentStrategySection.outerHTML = newStrategySection.outerHTML;
          }
        })
        .catch(error => {
          console.error('Error:', error);
          statusText.textContent = 'Error updating results';
        })
        .finally(() => {
          // Re-enable button and hide loading
          btn.disabled = false;
          loading.classList.remove('active');
        });
    }
    
    // Allow Enter key to trigger update
    document.getElementById('threshold').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        updateThreshold();
      }
    });    
    // Auto-refresh functionality
    let autoRefreshInterval = null;
    const autoRefreshToggle = document.getElementById('autoRefreshToggle');
    const refreshIntervalInput = document.getElementById('refreshInterval');
    const autoRefreshStatus = document.getElementById('autoRefreshStatus');
    
    function startAutoRefresh() {
      const intervalSeconds = parseInt(refreshIntervalInput.value) || 30;
      
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
      
      autoRefreshInterval = setInterval(() => {
        updateThreshold();
      }, intervalSeconds * 1000);
      
      autoRefreshStatus.textContent = `Refreshing every ${intervalSeconds}s`;
      autoRefreshStatus.classList.add('active');
    }
    
    function stopAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
      }
      autoRefreshStatus.textContent = '';
      autoRefreshStatus.classList.remove('active');
    }
    
    // Toggle auto-refresh
    autoRefreshToggle.addEventListener('change', function() {
      if (this.checked) {
        startAutoRefresh();
      } else {
        stopAutoRefresh();
      }
    });
    
    // Update interval when changed
    refreshIntervalInput.addEventListener('change', function() {
      if (autoRefreshToggle.checked) {
        startAutoRefresh();
      }
    });
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
      stopAutoRefresh();
    });

    
    // Sector filter functions
    function updateSectorUI() {
      const checkboxes = document.querySelectorAll('.sector-item input[type="checkbox"]');
      let selectedCount = 0;
      
      checkboxes.forEach(checkbox => {
        const sectorItem = checkbox.closest('.sector-item');
        if (checkbox.checked) {
          sectorItem.classList.add('checked');
          const countText = sectorItem.querySelector('.count').textContent;
          const count = parseInt(countText.match(/\d+/)[0]);
          selectedCount += count;
        } else {
          sectorItem.classList.remove('checked');
        }
      });
      
      document.getElementById('selectedSymbolCount').textContent = selectedCount;
    }
    
    function selectAllSectors() {
      document.querySelectorAll('.sector-grid input[type="checkbox"]').forEach(cb => {
        cb.checked = true;
      });
      updateSectorUI();
    }
    
    function clearAllSectors() {
      document.querySelectorAll('.sector-grid input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
      });
      updateSectorUI();
    }
    
    function getSelectedSectors() {
      const sectors = [];
      document.querySelectorAll('.sector-grid input[type="checkbox"]:checked').forEach(cb => {
        sectors.push(cb.value);
      });
      return sectors;
    }
    
    function getSelectedAssetTypes() {
      const types = [];
      document.querySelectorAll('.asset-type-grid input[type="checkbox"]:checked').forEach(cb => {
        types.push(cb.value);
      });
      return types;
    }
    
    function applyFilters() {
      const selectedSectors = getSelectedSectors();
      const selectedTypes = getSelectedAssetTypes();
      const threshold = document.getElementById('threshold').value;
      
      // Build query parameters
      const params = new URLSearchParams();
      params.set('threshold', threshold);
      
      if (selectedSectors.length > 0) {
        params.set('sectors', selectedSectors.join(','));
      }
      
      if (selectedTypes.length > 0) {
        params.set('asset_types', selectedTypes.join(','));
      }
      
      // Show loading state
      const btn = document.getElementById('updateBtn');
      const loading = document.getElementById('loading');
      const statusText = document.getElementById('statusText');
      
      btn.disabled = true;
      loading.classList.add('active');
      statusText.textContent = 'Scanning with filters...';
      
      // Fetch with filters
      fetch(`/dashboard?${params.toString()}`)
        .then(response => response.text())
        .then(html => {
          // Update the page content
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          
          // Update results sections
          const resultsBody = document.getElementById('resultsBody');
          const newBody = doc.getElementById('resultsBody');
          if (newBody && resultsBody) {
            resultsBody.innerHTML = newBody.innerHTML;
          }
          
          // Update strategy section
          const strategySection = document.querySelector('.strategy-section');
          const newStrategySection = doc.querySelector('.strategy-section');
          if (newStrategySection && strategySection) {
            strategySection.outerHTML = newStrategySection.outerHTML;
          }
          
          // Update status
          const newStatus = doc.getElementById('statusText');
          if (newStatus) {
            statusText.textContent = newStatus.textContent;
          }
        })
        .catch(error => {
          console.error('Error applying filters:', error);
          statusText.textContent = 'Error applying filters';
        })
        .finally(() => {
          btn.disabled = false;
          loading.classList.remove('active');
        });
    }
    
    // Initialize sector checkboxes
    document.addEventListener('DOMContentLoaded', function() {
      // Add change listeners to all checkboxes
      document.querySelectorAll('.sector-item input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateSectorUI);
      });
      
      // Initial UI update
      updateSectorUI();
    });
  </script>

<!-- Include Analysis Modal -->
{% include 'components/analysis_modal.html' %}

<!-- Include Chart.js for charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>

<!-- Include Logger (must be before analysis_modal.js) -->
<script src="/static/js/logger.js"></script>

<!-- Ensure all console messages are visible (including Google messages) -->
<script>
  // Ensure console methods are not filtered - show all messages including Google
  if (window.console) {
    // Restore original console methods if they were overridden
    const originalConsole = {
      log: console.log.bind(console),
      warn: console.warn.bind(console),
      error: console.error.bind(console),
      info: console.info.bind(console),
      debug: console.debug.bind(console)
    };
    
    // Ensure all console messages are displayed (no filtering)
    console.log = originalConsole.log;
    console.warn = originalConsole.warn;
    console.error = originalConsole.error;
    console.info = originalConsole.info;
    console.debug = originalConsole.debug;
  }
</script>

<!-- Include Modal JavaScript -->
<script src="/static/js/analysis_modal.js"></script>
</body>
</html>
